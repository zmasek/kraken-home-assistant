<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=640, height=640, initial-scale=1.0">
    <title>Kraken Display</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 640px;
            height: 640px;
            margin: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            flex-direction: column;
        }

        .circle {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 5px solid white;
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .settings {
            display: none;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        input, button {
            font-size: 1rem;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="circle" id="temperatureDisplay">Loading...</div>

    <button onclick="toggleSettings()">Settings</button>

    <div class="settings" id="settingsPanel">
        <label>Bearer Token: <input type="password" id="token" placeholder="Your Bearer Token"></label>
        <label>Webhook URL (Send Data): <input type="text" id="webhookSendUrl" placeholder="https://your-instance.ui.nabu.casa/api/webhook/kraken_update"></label>
        <button onclick="saveSettings()">Save Settings</button>
    </div>

    <script>
        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            panel.style.display = panel.style.display === "none" ? "flex" : "none";
        }

        function saveSettings() {
            const token = document.getElementById("token").value.trim();
            const webhookSendUrl = document.getElementById("webhookSendUrl").value.trim();

            if (!token || !webhookSendUrl) {
                alert("Please fill in all fields!");
                return;
            }

            localStorage.setItem("token", token);
            localStorage.setItem("webhookSendUrl", webhookSendUrl);

            alert("Settings saved!");
            toggleSettings();
            fetchDisplayData(); // Refresh data after saving
        }

        function loadSettings() {
            document.getElementById("token").value = localStorage.getItem("token") || "";
            document.getElementById("webhookSendUrl").value = localStorage.getItem("webhookSendUrl") || "";
        }

        async function triggerWebhook() {
            const webhookSendUrl = localStorage.getItem("webhookSendUrl");
            const token = localStorage.getItem("token");
            
            if (!webhookSendUrl || !token) {
                console.error("Webhook Send URL or token not set!");
                return;
            }
    
            try {
                const response = await fetch(webhookSendUrl, {
                    headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" }
                });

                if (!response.ok) throw new Error("Invalid response");

                const data = await response.json();
                document.getElementById("temperatureDisplay").innerText = `${data.fetched}Â°C`; // Update UI
            } catch (error) {
                console.error("Error fetching Home Assistant data:", error);
                document.getElementById("temperatureDisplay").innerText = "Error!";
            }
        }

        // Load saved settings on page load
        loadSettings();

        // Trigger webhook
        setTimeout(triggerWebhook, 2000);
        setInterval(triggerWebhook, 10000); // Refresh every 10s
    </script>
</body>
</html>
