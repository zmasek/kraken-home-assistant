<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=640, height=640, initial-scale=1.0">
    <title>Kraken Display</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 640px;
            height: 640px;
            margin: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            flex-direction: column;
        }

        .circle {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 5px solid white;
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .settings {
            display: none;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        input, button {
            font-size: 1rem;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="circle" id="temperatureDisplay">Loading...</div>

    <button onclick="toggleSettings()">Settings</button>

    <div class="settings" id="settingsPanel">
        <label>Nabu Casa URL: <input type="text" id="haUrl" placeholder="https://your-instance.ui.nabu.casa"></label>
        <label>Webhook URL: <input type="text" id="webhookUrl" placeholder="https://your-instance.ui.nabu.casa/api/webhook/your_webhook_id"></label>
        <label>Home Assistant Token: <input type="password" id="haToken"></label>
        <button onclick="saveSettings()">Save Settings</button>
    </div>

    <script>
        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            panel.style.display = panel.style.display === "none" ? "flex" : "none";
        }

        function saveSettings() {
            const haUrl = document.getElementById("haUrl").value.trim();
            const webhookUrl = document.getElementById("webhookUrl").value.trim();
            const haToken = document.getElementById("haToken").value.trim();

            if (!haUrl || !webhookUrl || !haToken) {
                alert("Please fill in all fields!");
                return;
            }

            localStorage.setItem("haUrl", haUrl);
            localStorage.setItem("webhookUrl", webhookUrl);
            localStorage.setItem("haToken", haToken);

            alert("Settings saved!");
            toggleSettings();
            fetchDisplayData(); // Refresh data after saving
        }

        function loadSettings() {
            document.getElementById("haUrl").value = localStorage.getItem("haUrl") || "";
            document.getElementById("webhookUrl").value = localStorage.getItem("webhookUrl") || "";
            document.getElementById("haToken").value = localStorage.getItem("haToken") || "";
        }

        async function triggerWebhook() {
            const webhookUrl = localStorage.getItem("webhookUrl");
            if (!webhookUrl) {
                console.error("Webhook URL not set!");
                return;
            }

            await fetch(webhookUrl, { method: "POST" }); // Trigger HA to update data
        }

        async function fetchDisplayData() {
            const haUrl = localStorage.getItem("haUrl");
            const haToken = localStorage.getItem("haToken");

            if (!haUrl || !haToken) {
                document.getElementById("temperatureDisplay").innerText = "Missing Settings!";
                return;
            }

            try {
                const response = await fetch(`${haUrl}/api/states/input_text.kraken_display`, {
                    headers: { "Authorization": `Bearer ${haToken}`, "Content-Type": "application/json" }
                });

                if (!response.ok) throw new Error("Invalid response");

                const data = await response.json();
                document.getElementById("temperatureDisplay").innerText = data.state; // Update UI
            } catch (error) {
                console.error("Error fetching Home Assistant data:", error);
                document.getElementById("temperatureDisplay").innerText = "Error!";
            }
        }

        // Load saved settings on page load
        loadSettings();

        // Trigger webhook, then fetch data after 2 sec
        triggerWebhook();
        setTimeout(fetchDisplayData, 2000);
        setInterval(fetchDisplayData, 10000); // Refresh every 10s
    </script>
</body>
</html>
